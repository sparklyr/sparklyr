<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using sparklyr with an Apache Spark cluster • sparklyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sparklyr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/gallery.html">Gallery</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/guides-dplyr.html">dplyr</a>
    </li>
    <li>
      <a href="../articles/guides-mllib.html">mllib</a>
    </li>
    <li>
      <a href="../articles/guides-distributed-r.html">Distributed R</a>
    </li>
    <li>
      <a href="../articles/deployment-connections.html">User connection options</a>
    </li>
    <li>
      <a href="../articles/guides-caching.html">Caching</a>
    </li>
    <li>
      <a href="../articles/guides-h2o.html">H2O</a>
    </li>
    <li>
      <a href="../articles/guides-extensions.html">Extensions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Deployment
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/deployment-overview.html">Overview</a>
    </li>
    <li>
      <a href="../articles/deployment-data-lakes.html">Data Lakes</a>
    </li>
    <li>
      <a href="../articles/deployment-cdh.html">Cloudera</a>
    </li>
    <li>
      <a href="../articles/deployment-amazon.html">Amazon</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Reference
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Functions</a>
    </li>
    <li>
      <a href="https://github.com/rstudio/cheatsheets/raw/master/source/pdfs/sparklyr.pdf">Cheatsheet</a>
    </li>
    <li>
      <a href="../articles/reference-media.html">Media</a>
    </li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/sparklyr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using sparklyr with an Apache Spark cluster</h1>
            
          </div>

    
    
<div class="contents">
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>This document demonstrates how to use <code>sparklyr</code> with an Cloudera Hadoop &amp; Spark cluster. Data are downloaded from the web and stored in Hive tables on HDFS across multiple worker nodes. RStudio Server is installed on the master node and orchestrates the analysis in spark.</p>
</div>
<div id="cloudera-cluster" class="section level1">
<h1 class="hasAnchor">
<a href="#cloudera-cluster" class="anchor"></a>Cloudera Cluster</h1>
<p>This demonstration is focused on adding RStudio integration to an existing Cloudera cluster. The assumption will be made that there no aid is needed to setup and administer the cluster.</p>
<div id="cdh-5" class="section level2">
<h2 class="hasAnchor">
<a href="#cdh-5" class="anchor"></a>CDH 5</h2>
<p>We will start with a Cloudera cluster CDH version 5.8.2 (free version) with an underlaying Ubuntu Linux distribution.</p>
<p><img src="images/deployment/cdh/manager-landing-page.png" width="600/"></p>
</div>
<div id="spark-1-6" class="section level2">
<h2 class="hasAnchor">
<a href="#spark-1-6" class="anchor"></a>Spark 1.6</h2>
<p>The default Spark 1.6.0 parcel is in installed and running</p>
<p><img src="images/deployment/cdh/spark-history-server-1.png" width="600/"></p>
</div>
<div id="hive-data" class="section level2">
<h2 class="hasAnchor">
<a href="#hive-data" class="anchor"></a>Hive data</h2>
<p>For this demo, we have created and populated 3 tables in Hive. The table names are: flights, airlines and airports. Using Hue, we can see the loaded tables. For the links to the data files and their Hive import scripts please see <em>Appendix A</em>.</p>
<p><img src="images/deployment/cdh/hue-metastore-1.png" width="600/"></p>
</div>
</div>
<div id="install-rstudio" class="section level1">
<h1 class="hasAnchor">
<a href="#install-rstudio" class="anchor"></a>Install RStudio</h1>
<p>The latest version of R is needed. In Ubuntu, the default core R is not the latest so we have to update the source list. We will also install a few other dependencies.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> sh -c <span class="st">'echo "deb http://cran.rstudio.com/bin/linux/ubuntu trusty/" &gt;&gt; /etc/apt/sources.list'</span>
<span class="ex">gpg</span> --keyserver keyserver.ubuntu.com --recv-key E084DAB9
<span class="ex">gpg</span> -a --export E084DAB9 <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -
<span class="fu">sudo</span> apt-get update
<span class="fu">sudo</span> apt-get install r-base
<span class="fu">sudo</span> apt-get install gdebi-core
<span class="fu">sudo</span> apt-get -y install libcurl4-gnutls-dev
<span class="fu">sudo</span> apt-get -y install libssl-dev</code></pre></div>
<p>We will install the preview version of RStudio Server</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> https://s3.amazonaws.com/rstudio-dailybuilds/rstudio-server-1.0.40-amd64.deb
<span class="fu">sudo</span> gdebi rstudio-server-1.0.49-amd64.deb</code></pre></div>
<div id="create-and-configure-a-user" class="section level3">
<h3 class="hasAnchor">
<a href="#create-and-configure-a-user" class="anchor"></a>Create and configure a User</h3>
<p>Create a user called <code>rstudio</code> that will perform the data analysis.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> adduser rstudio</code></pre></div>
<p>To ease security restriction in this demo, we will add the new user to the default super group defined in the <strong>dfs.permissions.superusergroup</strong> setting in CDH</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> groupadd supergroup
<span class="fu">sudo</span> usermod -a -G supergroup rstudio</code></pre></div>
</div>
</div>
<div id="connect-to-spark" class="section level1">
<h1 class="hasAnchor">
<a href="#connect-to-spark" class="anchor"></a>Connect to Spark</h1>
<p>Log in to RStudio Server by pointing a browser at your master node IP:8787.</p>
<p>
<img src="images/deployment/cdh/sign-in-1.png" width="600/"></p>
<p>Set the environment variable <code>SPARK_HOME</code> and then run <code>spark_connect</code>. After connecting you will be able to browse the Hive metadata in the RStudio Server Spark pane.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sparklyr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)

sc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spark-connections.html">spark_connect</a></span>(<span class="dt">master =</span> <span class="st">"yarn-client"</span>, <span class="dt">version=</span><span class="st">"1.6.0"</span>, <span class="dt">spark_home =</span> <span class="st">'/opt/cloudera/parcels/CDH/lib/spark/'</span>)</code></pre></div>
<p>Once you are connected, you will see the Spark pane appear along with your hive tables.</p>
<p>
<img src="images/deployment/cdh/spark-pane-1.png" width="600/"></p>
<p>You can inspect your tables by clicking on the data icon.</p>
<p>
<img src="images/deployment/cdh/tables-1.png" width="600/"></p>
<p>This is what the tables look like loaded in Spark via the History Server Web UI (port 18088)</p>
<p>
<img src="images/deployment/cdh/spark-rdd-1.png" width="600/"></p>
</div>
<div id="data-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#data-analysis" class="anchor"></a>Data analysis</h1>
<p>Is there evidence to suggest that some airline carriers make up time in flight? This analysis predicts time gained in flight by airline carrier.</p>
<p>
<img src="images/deployment/cdh/data-analysis-1.png" width="600/"></p>
<div id="cache-the-tables-into-memory" class="section level2">
<h2 class="hasAnchor">
<a href="#cache-the-tables-into-memory" class="anchor"></a>Cache the tables into memory</h2>
<p>Use <code>tbl_cache</code> to load the flights table into memory. Caching tables will make analysis much faster. Create a dplyr reference to the Spark DataFrame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Cache flights Hive table into Spark</span>
<span class="kw"><a href="../reference/tbl_cache.html">tbl_cache</a></span>(sc, <span class="st">'flights'</span>)
flights_tbl &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(sc, <span class="st">'flights'</span>)

<span class="co"># Cache airlines Hive table into Spark</span>
<span class="kw"><a href="../reference/tbl_cache.html">tbl_cache</a></span>(sc, <span class="st">'airlines'</span>)
airlines_tbl &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(sc, <span class="st">'airlines'</span>)

<span class="co"># Cache airports Hive table into Spark</span>
<span class="kw"><a href="../reference/tbl_cache.html">tbl_cache</a></span>(sc, <span class="st">'airports'</span>)
airports_tbl &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(sc, <span class="st">'airports'</span>)</code></pre></div>
</div>
<div id="create-a-model-data-set" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-model-data-set" class="anchor"></a>Create a model data set</h2>
<p>Filter the data to contain only the records to be used in the fitted model. Join carrier descriptions for reference. Create a new variable called <code>gain</code> which represents the amount of time gained (or lost) in flight.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filter records and create target variable 'gain'</span>
model_data &lt;-<span class="st"> </span>flights_tbl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="kw">is.na</span>(arrdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(depdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(distance)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(depdelay <span class="op">&gt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">&amp;</span><span class="st"> </span>depdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">240</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(arrdelay <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="dv">60</span> <span class="op">&amp;</span><span class="st"> </span>arrdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">360</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(year <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2003</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2007</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(airlines_tbl, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"uniquecarrier"</span> =<span class="st"> "code"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">gain =</span> depdelay <span class="op">-</span><span class="st"> </span>arrdelay) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain)

<span class="co"># Summarize data by carrier</span>
model_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(uniquecarrier) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">description =</span> <span class="kw">min</span>(description), <span class="dt">gain=</span><span class="kw">mean</span>(gain), 
            <span class="dt">distance=</span><span class="kw">mean</span>(distance), <span class="dt">depdelay=</span><span class="kw">mean</span>(depdelay)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(description, gain, distance, depdelay) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(gain)</code></pre></div>
<pre><code>Source:   query [?? x 4]
Database: spark connection master=yarn-client app=sparklyr local=FALSE

                    description       gain  distance depdelay
                          &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1        ATA Airlines d/b/a ATA -5.5679651 1240.7219 61.84391
2       Northwest Airlines Inc. -3.1134556  779.1926 48.84979
3                     Envoy Air -2.2056576  437.0883 54.54923
4             PSA Airlines Inc. -1.9267647  500.6955 55.60335
5  ExpressJet Airlines Inc. (1) -1.5886314  537.3077 61.58386
6               JetBlue Airways -1.3742524 1087.2337 59.80750
7         SkyWest Airlines Inc. -1.1265678  419.6489 54.04198
8          Delta Air Lines Inc. -0.9829374  956.9576 50.19338
9        American Airlines Inc. -0.9631200 1066.8396 56.78222
10  AirTran Airways Corporation -0.9411572  665.6574 53.38363
# ... with more rows</code></pre>
</div>
<div id="train-a-linear-model" class="section level2">
<h2 class="hasAnchor">
<a href="#train-a-linear-model" class="anchor"></a>Train a linear model</h2>
<p>Predict time gained or lost in flight as a function of distance, departure delay, and airline carrier.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Partition the data into training and validation sets</span>
model_partition &lt;-<span class="st"> </span>model_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/sdf_partition.html">sdf_partition</a></span>(<span class="dt">train =</span> <span class="fl">0.8</span>, <span class="dt">valid =</span> <span class="fl">0.2</span>, <span class="dt">seed =</span> <span class="dv">5555</span>)

<span class="co"># Fit a linear model</span>
ml1 &lt;-<span class="st"> </span>model_partition<span class="op">$</span>train <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/ml_linear_regression.html">ml_linear_regression</a></span>(gain <span class="op">~</span><span class="st"> </span>distance <span class="op">+</span><span class="st"> </span>depdelay <span class="op">+</span><span class="st"> </span>uniquecarrier)

<span class="co"># Summarize the linear model</span>
<span class="kw">summary</span>(ml1)</code></pre></div>
<pre><code>Call: ml_linear_regression(., gain ~ distance + depdelay + uniquecarrier)

Deviance Residuals: (approximate):
     Min       1Q   Median       3Q      Max 
-302.343   -5.669    2.714    9.832  104.130 

Coefficients:
                    Estimate  Std. Error  t value  Pr(&gt;|t|)    
(Intercept)      -1.26566581  0.10385870 -12.1864 &lt; 2.2e-16 ***
distance          0.00308711  0.00002404 128.4155 &lt; 2.2e-16 ***
depdelay         -0.01397013  0.00028816 -48.4812 &lt; 2.2e-16 ***
uniquecarrier_AA -2.18483090  0.10985406 -19.8885 &lt; 2.2e-16 ***
uniquecarrier_AQ  3.14330242  0.29114487  10.7964 &lt; 2.2e-16 ***
uniquecarrier_AS  0.09210380  0.12825003   0.7182 0.4726598    
uniquecarrier_B6 -2.66988794  0.12682192 -21.0523 &lt; 2.2e-16 ***
uniquecarrier_CO -1.11611186  0.11795564  -9.4621 &lt; 2.2e-16 ***
uniquecarrier_DL -1.95206198  0.11431110 -17.0767 &lt; 2.2e-16 ***
uniquecarrier_EV  1.70420830  0.11337215  15.0320 &lt; 2.2e-16 ***
uniquecarrier_F9 -1.03178176  0.15384863  -6.7065 1.994e-11 ***
uniquecarrier_FL -0.99574060  0.12034738  -8.2739 2.220e-16 ***
uniquecarrier_HA -1.16970713  0.34894788  -3.3521 0.0008020 ***
uniquecarrier_MQ -1.55569040  0.10975613 -14.1741 &lt; 2.2e-16 ***
uniquecarrier_NW -3.58502418  0.11534938 -31.0797 &lt; 2.2e-16 ***
uniquecarrier_OH -1.40654797  0.12034858 -11.6873 &lt; 2.2e-16 ***
uniquecarrier_OO -0.39069404  0.11132164  -3.5096 0.0004488 ***
uniquecarrier_TZ -7.26285217  0.34428509 -21.0955 &lt; 2.2e-16 ***
uniquecarrier_UA -0.56995737  0.11186757  -5.0949 3.489e-07 ***
uniquecarrier_US -0.52000028  0.11218498  -4.6352 3.566e-06 ***
uniquecarrier_WN  4.22838982  0.10629405  39.7801 &lt; 2.2e-16 ***
uniquecarrier_XE -1.13836940  0.11332176 -10.0455 &lt; 2.2e-16 ***
uniquecarrier_YV  3.17149538  0.11709253  27.0854 &lt; 2.2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

R-Squared: 0.02301
Root Mean Squared Error: 17.83</code></pre>
</div>
<div id="assess-model-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#assess-model-performance" class="anchor"></a>Assess model performance</h2>
<p>Compare the model performance using the validation data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate average gains by predicted decile</span>
model_deciles &lt;-<span class="st"> </span><span class="kw">lapply</span>(model_partition, <span class="cf">function</span>(x) {
  <span class="kw"><a href="../reference/sdf_predict.html">sdf_predict</a></span>(ml1, x) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">decile =</span> <span class="kw"><a href="http://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(prediction), <span class="dv">10</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(decile) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">gain =</span> <span class="kw">mean</span>(gain)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(decile, gain) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()
})

<span class="co"># Create a summary dataset for plotting</span>
deciles &lt;-<span class="st"> </span><span class="kw">rbind</span>(
  <span class="kw">data.frame</span>(<span class="dt">data =</span> <span class="st">'train'</span>, model_deciles<span class="op">$</span>train),
  <span class="kw">data.frame</span>(<span class="dt">data =</span> <span class="st">'valid'</span>, model_deciles<span class="op">$</span>valid),
  <span class="dt">make.row.names =</span> <span class="ot">FALSE</span>
)

<span class="co"># Plot average gains by predicted decile</span>
deciles <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="kw">factor</span>(decile), gain, <span class="dt">fill =</span> data)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_bar">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">'identity'</span>, <span class="dt">position =</span> <span class="st">'dodge'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">title =</span> <span class="st">'Average gain by predicted decile'</span>, <span class="dt">x =</span> <span class="st">'Decile'</span>, <span class="dt">y =</span> <span class="st">'Minutes'</span>)</code></pre></div>
<p>
<img src="images/deployment/cdh/performance-1.png" width="600/"></p>
</div>
<div id="visualize-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#visualize-predictions" class="anchor"></a>Visualize predictions</h2>
<p>Compare actual gains to predicted gains for an out of time sample.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select data from an out of time sample</span>
data_<span class="dv">2008</span> &lt;-<span class="st"> </span>flights_tbl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="kw">is.na</span>(arrdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(depdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(distance)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(depdelay <span class="op">&gt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">&amp;</span><span class="st"> </span>depdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">240</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(arrdelay <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="dv">60</span> <span class="op">&amp;</span><span class="st"> </span>arrdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">360</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2008</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(airlines_tbl, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"uniquecarrier"</span> =<span class="st"> "code"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">gain =</span> depdelay <span class="op">-</span><span class="st"> </span>arrdelay) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain, origin,dest)

<span class="co"># Summarize data by carrier</span>
carrier &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sdf_predict.html">sdf_predict</a></span>(ml1, data_<span class="dv">2008</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(description) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">gain =</span> <span class="kw">mean</span>(gain), <span class="dt">prediction =</span> <span class="kw">mean</span>(prediction), <span class="dt">freq =</span> <span class="kw"><a href="http://dplyr.tidyverse.org/reference/n.html">n</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(freq <span class="op">&gt;</span><span class="st"> </span><span class="dv">10000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>collect

<span class="co"># Plot actual gains and predicted gains by airline carrier</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(carrier, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(gain, prediction)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="dt">alpha =</span> <span class="fl">0.75</span>, <span class="dt">color =</span> <span class="st">'red'</span>, <span class="dt">shape =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_abline">geom_abline</a></span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">0.15</span>, <span class="dt">color =</span> <span class="st">'blue'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_text">geom_text</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">label =</span> <span class="kw">substr</span>(description, <span class="dv">1</span>, <span class="dv">20</span>)), <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">0.75</span>, <span class="dt">vjust =</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">title=</span><span class="st">'Average Gains Forecast'</span>, <span class="dt">x =</span> <span class="st">'Actual'</span>, <span class="dt">y =</span> <span class="st">'Predicted'</span>)</code></pre></div>
<p>
<img src="images/deployment/cdh/forecast-1.png" width="600/"></p>
<p>Some carriers make up more time than others in flight, but the differences are relatively small. The average time gains between the best and worst airlines is only six minutes. The best predictor of time gained is not carrier but flight distance. The biggest gains were associated with the longest flights.</p>
</div>
</div>
<div id="share-insights" class="section level1">
<h1 class="hasAnchor">
<a href="#share-insights" class="anchor"></a>Share Insights</h1>
<p>This simple linear model contains a wealth of detailed information about carriers, distances traveled, and flight delays. These detailed insights can be conveyed to a non-technical audiance via an interactive <a href="http://rmarkdown.rstudio.com/flexdashboard/index.html">flexdashboard</a>.</p>
<div id="build-dashboard" class="section level2">
<h2 class="hasAnchor">
<a href="#build-dashboard" class="anchor"></a>Build dashboard</h2>
<p>Aggregate the scored data by origin, destination, and airline. Save the aggregated data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Summarize by origin, destination, and carrier</span>
summary_<span class="dv">2008</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sdf_predict.html">sdf_predict</a></span>(ml1, data_<span class="dv">2008</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">carrier =</span> uniquecarrier, <span class="dt">airline =</span> description) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(origin, dest, carrier, airline) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(
    <span class="dt">flights =</span> <span class="kw"><a href="http://dplyr.tidyverse.org/reference/n.html">n</a></span>(),
    <span class="dt">distance =</span> <span class="kw">mean</span>(distance),
    <span class="dt">avg_dep_delay =</span> <span class="kw">mean</span>(depdelay),
    <span class="dt">avg_arr_delay =</span> <span class="kw">mean</span>(arrdelay),
    <span class="dt">avg_gain =</span> <span class="kw">mean</span>(gain),
    <span class="dt">pred_gain =</span> <span class="kw">mean</span>(prediction)
    )

<span class="co"># Collect and save objects</span>
pred_data &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>(summary_<span class="dv">2008</span>)
airports &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(airports_tbl, name, faa, lat, lon))
ml1_summary &lt;-<span class="st"> </span><span class="kw">capture.output</span>(<span class="kw">summary</span>(ml1))
<span class="kw">save</span>(pred_data, airports, ml1_summary, <span class="dt">file =</span> <span class="st">'flights_pred_2008.RData'</span>)</code></pre></div>
</div>
<div id="publish-dashboard" class="section level2">
<h2 class="hasAnchor">
<a href="#publish-dashboard" class="anchor"></a>Publish dashboard</h2>
<p>Use the saved data to build an R Markdown <a href="http://rmarkdown.rstudio.com/flexdashboard/index.html">flexdashboard</a>. Publish the flexdashboard</p>
<p><img src="images/deployment/cdh/flex-1.png" width="600/"></p>
</div>
</div>
<div id="appendix" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h1>
<div id="appendix-a---data-files" class="section level3">
<h3 class="hasAnchor">
<a href="#appendix-a---data-files" class="anchor"></a>Appendix A - Data files</h3>
<p>Run the following script to download data from the web onto your master node. Download the yearly flight data and the airlines lookup table.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Make download directory</span>
<span class="fu">mkdir</span> /tmp/flights

<span class="co"># Download flight data by year</span>
<span class="kw">for</span> <span class="ex">i</span> in <span class="dt">{2006..2008}</span>
  <span class="kw"><a href="http://dplyr.tidyverse.org/reference/do.html">do</a></span>
    <span class="bu">echo</span> <span class="st">"</span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st"> </span><span class="va">$i</span><span class="st"> Download"</span>
    <span class="va">fnam=$i</span>.csv.bz2
    <span class="fu">wget</span> -O /tmp/flights/<span class="va">$fnam</span> http://stat-computing.org/dataexpo/2009/<span class="va">$fnam</span>
    <span class="bu">echo</span> <span class="st">"</span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st"> </span><span class="va">$i</span><span class="st"> Unzip"</span>
    <span class="fu">bunzip2</span> /tmp/flights/<span class="va">$fnam</span>
  <span class="kw">done</span>

<span class="co"># Download airline carrier data</span>
<span class="fu">wget</span> -O /tmp/airlines.csv http://www.transtats.bts.gov/Download_Lookup.asp?Lookup=L_UNIQUE_CARRIERS

<span class="co"># Download airports data</span>
<span class="fu">wget</span> -O /tmp/airports.csv https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat</code></pre></div>
</div>
<div id="hive-tables" class="section level3">
<h3 class="hasAnchor">
<a href="#hive-tables" class="anchor"></a>Hive tables</h3>
<p>We used the Hue interface, logged in as ‘admin’ to load the data into HDFS and then into Hive.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> EXTERNAL <span class="kw">TABLE</span> <span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> flights
(
<span class="dt">year</span> <span class="dt">int</span>,
<span class="dt">month</span> <span class="dt">int</span>,
dayofmonth <span class="dt">int</span>,
dayofweek <span class="dt">int</span>,
deptime <span class="dt">int</span>,
crsdeptime <span class="dt">int</span>,
arrtime <span class="dt">int</span>, 
crsarrtime <span class="dt">int</span>,
uniquecarrier string,
flightnum <span class="dt">int</span>,
tailnum string, 
actualelapsedtime <span class="dt">int</span>,
crselapsedtime <span class="dt">int</span>,
airtime string,
arrdelay <span class="dt">int</span>,
depdelay <span class="dt">int</span>, 
origin string,
dest string,
distance <span class="dt">int</span>,
taxiin string,
taxiout string,
cancelled <span class="dt">int</span>,
cancellationcode string,
diverted <span class="dt">int</span>,
carrierdelay string,
weatherdelay string,
nasdelay string,
securitydelay string,
lateaircraftdelay string
)
<span class="kw">ROW</span> FORMAT DELIMITED
FIELDS TERMINATED <span class="kw">BY</span> <span class="st">','</span>
LINES TERMINATED <span class="kw">BY</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>
TBLPROPERTIES(<span class="ot">"skip.header.line.count"</span>=<span class="ot">"1"</span>);</code></pre></div>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql">LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/admin/flights/2006.csv/'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> flights;
LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/admin/flights/2007.csv/'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> flights;
LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/admin/flights/2008.csv/'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> flights;</code></pre></div>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"># <span class="kw">Create</span> metadata <span class="kw">for</span> airlines
<span class="kw">CREATE</span> EXTERNAL <span class="kw">TABLE</span> <span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> airlines
(
Code string,
Description string
)
<span class="kw">ROW</span> FORMAT SERDE <span class="st">'org.apache.hadoop.hive.serde2.OpenCSVSerde'</span>
<span class="kw">WITH</span> SERDEPROPERTIES
(
<span class="ot">"separatorChar"</span> = <span class="st">'\,'</span>,
<span class="ot">"quoteChar"</span>     = <span class="st">'</span><span class="ch">\"</span><span class="st">'</span>
)
STORED <span class="kw">AS</span> TEXTFILE
tblproperties(<span class="ot">"skip.header.line.count"</span>=<span class="ot">"1"</span>);</code></pre></div>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql">LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/admin/L_UNIQUE_CARRIERS.csv'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> airlines;</code></pre></div>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> EXTERNAL <span class="kw">TABLE</span> <span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> airports
(
<span class="kw"><a href="http://dplyr.tidyverse.org/reference/id.html">id</a></span> string,
name string,
city string,
country string,
faa string,
icao string,
lat <span class="dt">double</span>,
lon <span class="dt">double</span>,
alt <span class="dt">int</span>,
<span class="fu">tz_offset</span> <span class="dt">double</span>,
dst string,
tz_name string
)
<span class="kw">ROW</span> FORMAT SERDE <span class="st">'org.apache.hadoop.hive.serde2.OpenCSVSerde'</span>
<span class="kw">WITH</span> SERDEPROPERTIES
(
<span class="ot">"separatorChar"</span> = <span class="st">'\,'</span>,
<span class="ot">"quoteChar"</span>     = <span class="st">'</span><span class="ch">\"</span><span class="st">'</span>
)
STORED <span class="kw">AS</span> TEXTFILE;</code></pre></div>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql">LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/admin/airports.dat'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> airports;</code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#summary">Summary</a></li>
      <li>
<a href="#cloudera-cluster">Cloudera Cluster</a><ul class="nav nav-pills nav-stacked">
<li><a href="#cdh-5">CDH 5</a></li>
      <li><a href="#spark-1-6">Spark 1.6</a></li>
      <li><a href="#hive-data">Hive data</a></li>
      </ul>
</li>
      <li><a href="#install-rstudio">Install RStudio</a></li>
      <li><a href="#connect-to-spark">Connect to Spark</a></li>
      <li>
<a href="#data-analysis">Data analysis</a><ul class="nav nav-pills nav-stacked">
<li><a href="#cache-the-tables-into-memory">Cache the tables into memory</a></li>
      <li><a href="#create-a-model-data-set">Create a model data set</a></li>
      <li><a href="#train-a-linear-model">Train a linear model</a></li>
      <li><a href="#assess-model-performance">Assess model performance</a></li>
      <li><a href="#visualize-predictions">Visualize predictions</a></li>
      </ul>
</li>
      <li>
<a href="#share-insights">Share Insights</a><ul class="nav nav-pills nav-stacked">
<li><a href="#build-dashboard">Build dashboard</a></li>
      <li><a href="#publish-dashboard">Publish dashboard</a></li>
      </ul>
</li>
      <li><a href="#appendix">Appendix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Javier Luraschi, Kevin Ushey, JJ Allaire,  The Apache Software Foundation.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
